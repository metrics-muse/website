AWSTemplateFormatVersion: 2010-09-09

Parameters:
  Environment:
    Type: String
    AllowedValues:
      - prod
      - staging
      - dev

  Repository:
    Type: String
    Description: GitHub Repository URL

  OauthToken:
    Type: String
    Description: GitHub Repository URL
    NoEcho: true

  Domain:
    Type: String
    Description: Domain name to host application

Conditions:
  IsProd: !Equals 
    - !Ref Environment
    - prod
  IsStaging: !Equals 
    - !Ref Environment
    - staging
  IsDev: !Equals 
    - !Ref Environment
    - dev

Resources:
  AmplifyRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - amplify.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: Amplify
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: "amplify:*"
                Resource: "*"

  AmplifyApp:
    Type: "AWS::Amplify::App"
    Properties:
      Name: Website
      Repository: !Ref Repository
      Description: Metrics Muse website
      OauthToken: !Ref OauthToken
      BuildSpec: |-
        version: 1
        frontend:
          phases:
            preBuild:
              commands:
                - npm ci
            build:
              commands:
                - npm run build
          artifacts:
            baseDirectory: build
            files:
              - '**/*'
          cache:
            paths:
              - node_modules/**/*
      CustomRules:
        - Source: public/index.html
          Target: /index.html
          Status: '200'
      Tags:
        - Key: Name
          Value: Website
      IAMServiceRole: !GetAtt AmplifyRole.Arn

  AmplifyMainBranch:
    Type: AWS::Amplify::Branch
    Condition: IsProd 
    Properties:
      BranchName: main
      AppId: !GetAtt AmplifyApp.AppId
      Description: Main Branch
      EnableAutoBuild: true
      Tags:
        - Key: Name
          Value: website-main
        - Key: Branch
          Value: main
          
  AmplifyStagingBranch:
    Type: AWS::Amplify::Branch
    Condition: IsStaging 
    Properties:
      BranchName: staging
      AppId: !GetAtt AmplifyApp.AppId
      Description: Staging Branch
      EnableAutoBuild: true
      Tags:
        - Key: Name
          Value: website-staging
        - Key: Branch
          Value: staging

  AmplifyDevBranch:
    Type: AWS::Amplify::Branch
    Condition: IsDev
    Properties:
      BranchName: develop
      AppId: !GetAtt AmplifyApp.AppId
      Description: Develop Branch
      EnableAutoBuild: true
      Tags:
        - Key: Name
          Value: website-develop
        - Key: Branch
          Value: develop

  AmplifyDomain:
    Type: AWS::Amplify::Domain
    Condition: IsProd
    Properties:
      DomainName: !Ref Domain
      AppId: !GetAtt AmplifyApp.AppId
      SubDomainSettings:
        - Prefix: www
          BranchName: !GetAtt AmplifyMainBranch.BranchName

  AmplifyDomain:
    Type: AWS::Amplify::Domain
    Condition: IsStaging
    Properties:
      DomainName: !Ref Domain
      AppId: !GetAtt AmplifyApp.AppId
      SubDomainSettings:
        - Prefix: staging
          BranchName: !GetAtt AmplifyStagingBranch.BranchName

  AmplifyDomain:
    Type: AWS::Amplify::Domain
    Condition: IsDev
    Properties:
      DomainName: !Ref Domain
      AppId: !GetAtt AmplifyApp.AppId
      SubDomainSettings:
        - Prefix: dev
          BranchName: !GetAtt AmplifyDevBranch.BranchName

Outputs:
  DefaultDomain:
    Value: !GetAtt AmplifyApp.DefaultDomain

  MainBranchUrl:
    Condition: IsProd
    Value: !Join [ ".", [ !GetAtt AmplifyMainBranch.BranchName, !GetAtt AmplifyDomain.DomainName ]]